<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Space War Game</title>
<style>
  body {
    margin: 0;
    background: black;
    overflow: hidden;
    color: white;
    font-family: Arial, sans-serif;
    user-select: none;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  #gameContainer {
    position: relative;
    width: 500px;
    height: 700px;
    border: 2px solid white;
    background: #000;
    touch-action: none;
  }
  canvas {
    display: block;
    background: transparent;
  }
  #result {
    text-align: center;
    margin-top: 10px;
    font-size: 20px;
    color: white;
    display: none;
  }
  #nameInputContainer {
    text-align: center;
    margin-top: 100px;
    color: white;
    font-family: Arial, sans-serif;
  }
  #nameInputContainer input[type="text"] {
    padding: 10px;
    font-size: 18px;
    width: 200px;
    border-radius: 5px;
    border: none;
  }
  #nameInputContainer button {
    padding: 10px 20px;
    font-size: 18px;
    margin-left: 10px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #2196f3;
    color: white;
  }
  #nameInputContainer button:hover {
    background-color: #0b7dda;
  }

  /* 手机触屏控件容器 */
  #touchControls {
    position: absolute;
    bottom: 20px;
    width: 100%;
    height: 120px;
    pointer-events: none; /* 默认不响应事件，按钮和杆会自己覆盖 */
    user-select: none;
  }

  /* 操作杆容器 */
  #touchJoystick {
    position: absolute;
    bottom: 0;
    left: 20px;
    width: 120px;
    height: 120px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    touch-action: none;
    pointer-events: auto;
  }
  #joystickThumb {
    position: absolute;
    width: 60px;
    height: 60px;
    background: rgba(255, 255, 255, 0.4);
    border-radius: 50%;
    top: 30px;
    left: 30px;
    touch-action: none;
  }

  /* 射击按钮 */
  #touchShootBtn {
    position: absolute;
    bottom: 20px;
    right: 20px;
    width: 90px;
    height: 90px;
    background: rgba(255, 0, 0, 0.3);
    border-radius: 50%;
    pointer-events: auto;
    touch-action: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 24px;
    color: white;
    user-select: none;
  }
  #touchShootBtn:active {
    background: rgba(255, 0, 0, 0.7);
  }
</style>
</head>
<body>

<div id="nameInputContainer">
  <label for="playerNameInput">请输入您的名字：</label>
  <input type="text" id="playerNameInput" maxlength="12" placeholder="你的名字" />
  <button id="startGameBtn">开始游戏</button>
</div>

<div id="gameContainer" style="display:none;">
  <canvas id="gameCanvas" width="500" height="700"></canvas>
  <div id="touchControls" style="display:none;">
    <div id="touchJoystick">
      <div id="joystickThumb"></div>
    </div>
    <div id="touchShootBtn">射击</div>
  </div>
</div>

<div id="result"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-iUFFdMZqfqOkIdExdq8G9ORyzfutay4",
    authDomain: "ranking-b8b7.firebaseapp.com",
    databaseURL: "https://ranking-b8b7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ranking-b8b7",
    storageBucket: "ranking-b8b7.appspot.com",
    messagingSenderId: "1094844971919",
    appId: "1:1094844971919:web:b526bd952f871bc8f6a9fa",
    measurementId: "G-NG7CDK13VN"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const explosionSound = new Audio("https://actions.google.com/sounds/v1/explosions/explosion.ogg");
  const shootSound = new Audio("https://actions.google.com/sounds/v1/weapons/laser_gun.ogg");

  const touchJoystick = document.getElementById("touchJoystick");
  const joystickThumb = document.getElementById("joystickThumb");
  const touchShootBtn = document.getElementById("touchShootBtn");

  let keys = {};
  let bullets = [];
  let enemies = [];
  let score = 0;
  let lives = 5;
  let gameOver = false;
  let infiniteMode = false; // 只有电脑有的无敌模式
  let playerName = "";

  let shootCooldown = 0;
  const normalShootCooldownMax = 15;

  let lostChancesUsed = 0;

  let enemySpawnInterval = 1200;
  let enemySpawnTimerId = null;
  let enemySpeedMultiplier = 1;
  let enemyHPBase = 1;
  let spacebarBulletDamage = 1;

  const spaceship = {
    x: canvas.width / 2 - 25,
    y: canvas.height - 80,
    width: 50,
    height: 60,
    speed: 7,
    joystickX: 0,
  };

  class Bullet {
    constructor(x, y, damage) {
      this.x = x;
      this.y = y;
      this.width = 6;
      this.height = 14;
      this.damage = damage;
    }
    draw() {
      ctx.fillStyle = "cyan";
      ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    update() {
      this.y -= 15;
    }
  }

  class Enemy {
    constructor(x, y, speed, hp) {
      this.x = x;
      this.y = y;
      this.width = 40;
      this.height = 40;
      this.speed = speed;
      this.hp = hp;
      this.alpha = 1;
      this.fading = false;
    }
    draw() {
      ctx.globalAlpha = this.alpha;
      ctx.fillStyle = "red";
      ctx.fillRect(this.x, this.y, this.width, this.height);

      if (!this.fading) {
        ctx.fillStyle = "lime";
        let hpBarWidth = (this.hp / enemyHPBase) * this.width;
        ctx.fillRect(this.x, this.y - 8, hpBarWidth, 5);
      }

      ctx.globalAlpha = 1;
    }
    update() {
      this.y += this.speed * enemySpeedMultiplier;

      if (this.fading) {
        this.alpha -= 0.01;
        if (this.alpha <= 0) {
          enemies.splice(enemies.indexOf(this), 1);
          lostChancesUsed++;
          if (lostChancesUsed >= 5) {
            endGame();
          }
        }
      }
    }
  }

  function spawnEnemy() {
    if (gameOver) return;

    let x = Math.random() * (canvas.width - 40);
    let speed = 0.5 + Math.random() * 0.75;
    let hp = enemyHPBase;
    enemies.push(new Enemy(x, -40, speed, hp));
  }

  function startEnemySpawner() {
    if (enemySpawnTimerId) clearInterval(enemySpawnTimerId);
    enemySpawnTimerId = setInterval(spawnEnemy, enemySpawnInterval);
  }

  function shoot(isOverpower = false) {
    if (gameOver) return;
    if (shootCooldown > 0 && !isOverpower) return;

    shootCooldown = normalShootCooldownMax;

    if (isOverpower) {
      for (let offset = -20; offset <= 20; offset += 10) {
        bullets.push(new Bullet(spaceship.x + spaceship.width / 2 + offset - 3, spaceship.y - 10, 1));
      }
      shootSound.currentTime = 0;
      shootSound.play();
    } else {
      bullets.push(new Bullet(spaceship.x + spaceship.width / 2 - 3, spaceship.y - 10, spacebarBulletDamage));
      shootSound.currentTime = 0;
      shootSound.play();
    }
  }

  function endGame() {
    gameOver = true;
    clearInterval(enemySpawnTimerId);
    enemies = [];
    bullets = [];
    draw();

    saveScoreToFirebase(playerName, score);

    const resultDiv = document.getElementById("result");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `
      <p>游戏结束</p>
      <p>玩家：${playerName}</p>
      <p>得分：${score}</p>
      <button onclick="location.href='minigames.html'">再玩一次</button>
      <button onclick="location.href='ranking.html'">查看排行榜</button>
    `;

    document.getElementById("gameContainer").style.display = "none";
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "white";
    ctx.fillRect(spaceship.x, spaceship.y, spaceship.width, spaceship.height);

    bullets.forEach(b => b.draw());
    enemies.forEach(e => e.draw());

    ctx.fillStyle = "white";
    ctx.font = "20px Arial";
    ctx.fillText("分数: " + score, 10, 30);
    ctx.fillText("生命: " + lives, 10, 60);

    if (gameOver) {
      ctx.fillStyle = "white";
      ctx.font = "40px Arial";
      ctx.textAlign = "center";
      ctx.fillText("游戏结束", canvas.width / 2, canvas.height / 2);
      ctx.font = "20px Arial";
      ctx.fillText("Made by Ivan :)", canvas.width / 2, canvas.height / 2 + 40);
      ctx.textAlign = "left";
    }
  }

  function update() {
    if (gameOver) return;

    // 电脑按键移动
    if (!isTouchDevice()) {
      if (keys["ArrowLeft"]) spaceship.x -= spaceship.speed;
      if (keys["ArrowRight"]) spaceship.x += spaceship.speed;
    } else {
      // 手机触屏操控杆控制
      spaceship.x += spaceship.joystickX * spaceship.speed;
    }

    if (spaceship.x < 0) spaceship.x = 0;
    if (spaceship.x + spaceship.width > canvas.width) spaceship.x = canvas.width - spaceship.width;

    if (shootCooldown > 0) shootCooldown--;

    if (infiniteMode && !gameOver) {
      shoot(true);
    }

    for (let i = bullets.length - 1; i >= 0; i--) {
      bullets[i].update();
      if (bullets[i].y < -bullets[i].height) {
        bullets.splice(i, 1);
      }
    }

    for (let i = enemies.length - 1; i >= 0; i--) {
      let enemy = enemies[i];
      enemy.update();

      if (!enemy.fading && enemy.y > canvas.height) {
        lives--;
        if (lives <= 0) {
          endGame();
        } else {
          enemy.fading = true;
        }
      }
    }

    for (let i = bullets.length - 1; i >= 0; i--) {
      let b = bullets[i];
      for (let j = enemies.length - 1; j >= 0; j--) {
        let e = enemies[j];
        if (
          b.x < e.x + e.width &&
          b.x + b.width > e.x &&
          b.y < e.y + e.height &&
          b.y + b.height > e.y
        ) {
          e.hp -= b.damage;
          if (e.hp <= 0) {
            explosionSound.currentTime = 0;
            explosionSound.play();
            score += 10;
            enemies.splice(j, 1);
          }
          bullets.splice(i, 1);
          break;
        }
      }
    }

    draw();
  }

  function isTouchDevice() {
    return (
      "ontouchstart" in window ||
      navigator.maxTouchPoints > 0 ||
      navigator.msMaxTouchPoints > 0
    );
  }

  // --- 触屏摇杆实现 ---
  let joystickActive = false;
  let joystickStartX = 0;
  let joystickStartY = 0;

  touchJoystick.addEventListener("touchstart", (e) => {
    e.preventDefault();
    joystickActive = true;
    const touch = e.touches[0];
    joystickStartX = touch.clientX;
    joystickStartY = touch.clientY;
  });

  touchJoystick.addEventListener("touchmove", (e) => {
    if (!joystickActive) return;
    e.preventDefault();
    const touch = e.touches[0];
    let deltaX = touch.clientX - joystickStartX;
    let deltaY = touch.clientY - joystickStartY;

    // 限制移动范围，最大30px半径
    let distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    if (distance > 30) {
      deltaX = (deltaX / distance) * 30;
      deltaY = (deltaY / distance) * 30;
    }

    joystickThumb.style.transform = `translate(${deltaX}px, ${deltaY}px)`;

    // 只要左右移动影响 x 轴
    spaceship.joystickX = deltaX / 30; // -1 ~ 1 之间的值
  });

  touchJoystick.addEventListener("touchend", (e) => {
    e.preventDefault();
    joystickActive = false;
    joystickThumb.style.transform = `translate(0px, 0px)`;
    spaceship.joystickX = 0;
  });

  // --- 触屏射击按钮 ---
  touchShootBtn.addEventListener("touchstart", (e) => {
    e.preventDefault();
    shoot(false);
  });

  // --- 键盘事件 ---
  window.addEventListener("keydown", (e) => {
    if (gameOver) return;
    keys[e.key] = true;

    if (e.key === "w" || e.key === "W") {
      infiniteMode = true;
    }
    if (e.key === " " || e.key === "Spacebar") {
      shoot(false);
    }
  });

  window.addEventListener("keyup", (e) => {
    keys[e.key] = false;

    if (e.key === "w" || e.key === "W") {
      infiniteMode = false;
    }
  });

  // 游戏开始按钮
  const startGameBtn = document.getElementById("startGameBtn");
  const nameInput = document.getElementById("playerNameInput");
  const nameInputContainer = document.getElementById("nameInputContainer");
  const gameContainer = document.getElementById("gameContainer");
  const touchControls = document.getElementById("touchControls");

  startGameBtn.addEventListener("click", () => {
    const nameVal = nameInput.value.trim();
    if (nameVal.length < 1) {
      alert("请输入名字！");
      return;
    }
    playerName = nameVal;
    nameInputContainer.style.display = "none";
    gameContainer.style.display = "block";

    if (isTouchDevice()) {
      touchControls.style.display = "block";
    }

    score = 0;
    lives = 5;
    gameOver = false;
    enemies = [];
    bullets = [];
    lostChancesUsed = 0;

    startEnemySpawner();
    gameLoop();
  });

  // 游戏循环
  function gameLoop() {
    update();
    if (!gameOver) {
      requestAnimationFrame(gameLoop);
    }
  }

  // Firebase写入
  function saveScoreToFirebase(name, score) {
    if (!name) return;
    const scoresRef = ref(db, "scores");
    push(scoresRef, { name: name, score: score });
  }
</script>

</body>
</html>
