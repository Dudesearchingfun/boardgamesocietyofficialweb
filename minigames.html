<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Space War Game</title>
<style>
  body { margin: 0; background: black; overflow: hidden; color: white; font-family: Arial, sans-serif; user-select: none; }
  canvas { display: block; margin: 0 auto; background: #000; border: 2px solid white; }
  #result { 
    text-align: center; margin-top: 10px; font-size: 20px; color: white;
    display: none;
  }
  #nameInputContainer {
    text-align: center;
    margin-top: 100px;
    color: white;
    font-family: Arial, sans-serif;
  }
  #nameInputContainer input[type="text"] {
    padding: 10px;
    font-size: 18px;
    width: 200px;
    border-radius: 5px;
    border: none;
  }
  #nameInputContainer button {
    padding: 10px 20px;
    font-size: 18px;
    margin-left: 10px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #2196f3;
    color: white;
  }
  #nameInputContainer button:hover {
    background-color: #0b7dda;
  }

  /* 新增触屏摇杆和射击按钮样式 */
  #touchJoystick {
    position: fixed;
    bottom: 50px;
    right: 20px;
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 50%;
    touch-action: none;
    user-select: none;
    display: none; /* 默认隐藏 */
    z-index: 1000;
  }
  #touchJoystick.active {
    background: rgba(255, 255, 255, 0.35);
  }
  #touchShootBtn {
    position: fixed;
    bottom: 60px;
    left: 20px;
    width: 60px;
    height: 60px;
    background: rgba(255, 0, 0, 0.6);
    border: none;
    border-radius: 50%;
    font-size: 16px;
    color: white;
    user-select: none;
    display: none; /* 默认隐藏 */
    z-index: 1000;
  }
</style>
</head>
<body>

<div id="nameInputContainer">
  <label for="playerNameInput">请输入您的名字：</label>
  <input type="text" id="playerNameInput" maxlength="12" placeholder="你的名字" />
  <button id="startGameBtn">开始游戏</button>
</div>

<canvas id="gameCanvas" width="500" height="700" style="display:none;"></canvas>
<div id="result"></div>

<!-- 触屏控制元素 -->
<div id="touchJoystick"></div>
<button id="touchShootBtn">射击</button>

<!-- Firebase SDK -->
<script type="module">
  // Import the Firebase modules you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC-iUFFdMZqfqOkIdExdq8G9ORyzfutay4",
    authDomain: "ranking-b8b7.firebaseapp.com",
    databaseURL: "https://ranking-b8b7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ranking-b8b7",
    storageBucket: "ranking-b8b7.appspot.com",
    messagingSenderId: "1094844971919",
    appId: "1:1094844971919:web:b526bd952f871bc8f6a9fa",
    measurementId: "G-NG7CDK13VN"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Game code below
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const explosionSound = new Audio("https://actions.google.com/sounds/v1/explosions/explosion.ogg");
  const shootSound = new Audio("https://actions.google.com/sounds/v1/weapons/laser_gun.ogg");

  let keys = {};
  let bullets = [];
  let enemies = [];
  let score = 0;
  let lives = 5;
  let gameOver = false;
  let infiniteMode = false; // W key模式（电脑端专属）
  let playerName = "";

  let shootCooldown = 0;
  const normalShootCooldownMax = 15;

  let lostChancesUsed = 0;

  let enemySpawnInterval = 1200;
  let enemySpawnTimerId = null;
  let enemySpeedMultiplier = 1;
  let enemyHPBase = 1;
  let spacebarBulletDamage = 1;

  const spaceship = {
    x: canvas.width / 2 - 25,
    y: canvas.height - 80,
    width: 50,
    height: 60,
    speed: 7,
  };

  class Bullet {
    constructor(x, y, damage) {
      this.x = x;
      this.y = y;
      this.width = 6;
      this.height = 14;
      this.damage = damage;
    }
    draw() {
      ctx.fillStyle = "cyan";
      ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    update() {
      this.y -= 15;
    }
  }

  class Enemy {
    constructor(x, y, speed, hp) {
      this.x = x;
      this.y = y;
      this.width = 40;
      this.height = 40;
      this.speed = speed;
      this.hp = hp;
      this.alpha = 1;
      this.fading = false;
    }
    draw() {
      ctx.globalAlpha = this.alpha;
      ctx.fillStyle = "red";
      ctx.fillRect(this.x, this.y, this.width, this.height);

      if (!this.fading) {
        ctx.fillStyle = "lime";
        let hpBarWidth = (this.hp / enemyHPBase) * this.width;
        ctx.fillRect(this.x, this.y - 8, hpBarWidth, 5);
      }

      ctx.globalAlpha = 1;
    }
    update() {
      this.y += this.speed * enemySpeedMultiplier;

      if (this.fading) {
        this.alpha -= 0.01;
        if (this.alpha <= 0) {
          enemies.splice(enemies.indexOf(this), 1);
          lostChancesUsed++;
          if (lostChancesUsed >= 5) {
            endGame();
          }
        }
      }
    }
  }

  function spawnEnemy() {
    if (gameOver) return;

    let x = Math.random() * (canvas.width - 40);
    let speed = 0.5 + Math.random() * 0.75;
    let hp = enemyHPBase;
    enemies.push(new Enemy(x, -40, speed, hp));
  }

  function startEnemySpawner() {
    if (enemySpawnTimerId) clearInterval(enemySpawnTimerId);
    enemySpawnTimerId = setInterval(spawnEnemy, enemySpawnInterval);
  }

  function shoot(isOverpower = false) {
    if (gameOver) return;
    if (shootCooldown > 0 && !isOverpower) return;

    shootCooldown = normalShootCooldownMax;

    if (isOverpower) {
      for (let offset = -20; offset <= 20; offset += 10) {
        bullets.push(new Bullet(spaceship.x + spaceship.width / 2 + offset - 3, spaceship.y - 10, 1));
      }
      shootSound.currentTime = 0;
      shootSound.play();
    } else {
      bullets.push(new Bullet(spaceship.x + spaceship.width / 2 - 3, spaceship.y - 10, spacebarBulletDamage));
      shootSound.currentTime = 0;
      shootSound.play();
    }
  }

  function endGame() {
    gameOver = true;
    clearInterval(enemySpawnTimerId);
    enemies = [];
    bullets = [];
    draw();

    saveScoreToFirebase(playerName, score);

    const resultDiv = document.getElementById("result");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `
      <p>游戏结束</p>
      <p>玩家：${playerName}</p>
      <p>得分：${score}</p>
      <button onclick="location.href='minigames.html'">再玩一次</button>
      <button onclick="location.href='ranking.html'">查看排行榜</button>
    `;

    canvas.style.display = "none";
    // 隐藏触屏按钮
    touchJoystick.style.display = 'none';
    touchShootBtn.style.display = 'none';
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "white";
    ctx.fillRect(spaceship.x, spaceship.y, spaceship.width, spaceship.height);

    bullets.forEach(b => b.draw());
    enemies.forEach(e => e.draw());

    ctx.fillStyle = "white";
    ctx.font = "20px Arial";
    ctx.fillText("分数: " + score, 10, 30);
    ctx.fillText("生命: " + lives, 10, 60);

    if (gameOver) {
      ctx.fillStyle = "white";
      ctx.font = "40px Arial";
      ctx.textAlign = "center";
      ctx.fillText("游戏结束", canvas.width / 2, canvas.height / 2);
      ctx.font = "20px Arial";
      ctx.fillText("请刷新重新开始", canvas.width / 2, canvas.height / 2 + 40);
      ctx.textAlign = "left";
    }
  }

  function update() {
    if (gameOver) return;

    if (shootCooldown > 0) shootCooldown--;

    // 键盘左右移动飞船
    if (keys["ArrowLeft"] || keys["a"]) {
      spaceship.x -= spaceship.speed;
      if (spaceship.x < 0) spaceship.x = 0;
    }
    if (keys["ArrowRight"] || keys["d"]) {
      spaceship.x += spaceship.speed;
      if (spaceship.x + spaceship.width > canvas.width)
        spaceship.x = canvas.width - spaceship.width;
    }

    // W键开启无敌模式（仅电脑端可用）
    if (!isTouchDevice() && keys["w"]) {
      infiniteMode = true;
      lives = 9999;
    } else if (!isTouchDevice()) {
      infiniteMode = false;
    }

    if (!infiniteMode && lives <= 0) {
      endGame();
      return;
    }

    bullets.forEach((b, i) => {
      b.update();
      if (b.y + b.height < 0) bullets.splice(i, 1);
    });

    enemies.forEach(e => e.update());

    // 碰撞检测：子弹和敌人
    bullets.forEach((b, bi) => {
      enemies.forEach((e, ei) => {
        if (
          b.x < e.x + e.width &&
          b.x + b.width > e.x &&
          b.y < e.y + e.height &&
          b.y + b.height > e.y
        ) {
          e.hp -= b.damage;
          bullets.splice(bi, 1);
          if (e.hp <= 0 && !e.fading) {
            e.fading = true;
            explosionSound.currentTime = 0;
            explosionSound.play();
            score += 10;
            enemySpeedMultiplier += 0.002;
            enemyHPBase += 0.01;
          }
        }
      });
    });

    // 碰撞检测：敌人和飞船
    enemies.forEach((e) => {
      if (
        e.y + e.height > spaceship.y &&
        e.x + e.width > spaceship.x &&
        e.x < spaceship.x + spaceship.width &&
        !e.fading
      ) {
        explosionSound.currentTime = 0;
        explosionSound.play();
        lives--;
        e.fading = true;
      }
    });

    draw();
    requestAnimationFrame(update);
  }

  // 监听键盘事件
  window.addEventListener("keydown", (e) => {
    keys[e.key.toLowerCase()] = true;
    if (e.key === " " || e.key === "Spacebar") {
      e.preventDefault();
      shoot(false);
    }
  });

  window.addEventListener("keyup", (e) => {
    keys[e.key.toLowerCase()] = false;
  });

  // 触屏控制代码（新增）

  const touchJoystick = document.getElementById("touchJoystick");
  const touchShootBtn = document.getElementById("touchShootBtn");

  function isTouchDevice() {
    return "ontouchstart" in window || navigator.maxTouchPoints > 0;
  }

  if (isTouchDevice()) {
    touchJoystick.style.display = "block";
    touchShootBtn.style.display = "block";
  }

  let joystickCenterX = 0;
  let dragging = false;

  touchJoystick.addEventListener("touchstart", (e) => {
    e.preventDefault();
    dragging = true;
    const touch = e.touches[0];
    joystickCenterX = touch.clientX;
    touchJoystick.classList.add("active");
  });

  touchJoystick.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!dragging) return;
    const touch = e.touches[0];
    let offset = touch.clientX - joystickCenterX;

    // 限制偏移范围
    if (offset > 40) offset = 40;
    if (offset < -40) offset = -40;

    // 根据偏移移动飞船，速度调节
    spaceship.x += offset * 0.15;

    // 限制飞船边界
    if (spaceship.x < 0) spaceship.x = 0;
    if (spaceship.x + spaceship.width > canvas.width)
      spaceship.x = canvas.width - spaceship.width;
  });

  touchJoystick.addEventListener("touchend", (e) => {
    e.preventDefault();
    dragging = false;
    touchJoystick.classList.remove("active");
  });

  touchShootBtn.addEventListener("touchstart", (e) => {
    e.preventDefault();
    shoot(false);
  });

  // 游戏开始按钮逻辑
  const startBtn = document.getElementById("startGameBtn");
  const nameInput = document.getElementById("playerNameInput");
  const nameInputContainer = document.getElementById("nameInputContainer");

  startBtn.addEventListener("click", () => {
    const val = nameInput.value.trim();
    if (val.length === 0) {
      alert("请输入名字再开始游戏！");
      return;
    }
    playerName = val;
    nameInputContainer.style.display = "none";
    canvas.style.display = "block";
    result.style.display = "none";
    startEnemySpawner();
    update();
  });

  // Firebase存分数
  function saveScoreToFirebase(name, score) {
    const scoresRef = ref(db, "scores");
    push(scoresRef, {
      name: name,
      score: score,
      timestamp: Date.now()
    });
  }
</script>
</body>
</html>
