<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Space War Game</title>
<style>
  body { margin: 0; background: black; overflow: hidden; color: white; font-family: Arial, sans-serif; user-select: none; }
  canvas { display: block; margin: 0 auto; background: #000; border: 2px solid white; }

  #result { 
    text-align: center; margin-top: 10px; font-size: 20px; color: white;
    display: none;
  }
  #nameInputContainer {
    text-align: center;
    margin-top: 100px;
    color: white;
    font-family: Arial, sans-serif;
  }
  #nameInputContainer input[type="text"] {
    padding: 10px;
    font-size: 18px;
    width: 200px;
    border-radius: 5px;
    border: none;
  }
  #nameInputContainer button {
    padding: 10px 20px;
    font-size: 18px;
    margin-left: 10px;
    cursor: pointer;
    border-radius: 5px;
    border: none;
    background-color: #2196f3;
    color: white;
  }
  #nameInputContainer button:hover {
    background-color: #0b7dda;
  }

  /* 触屏摇杆和按钮样式 */
  #touchJoystick {
    position: fixed;
    bottom: 60px;
    right: 20px;
    width: 80px;
    height: 80px;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    touch-action: none;
    user-select: none;
    z-index: 1000;
  }
  #touchJoystick.active {
    background: rgba(255,255,255,0.4);
  }
  #touchShootBtn {
    position: fixed;
    bottom: 60px;
    left: 20px;
    width: 80px;
    height: 80px;
    background: rgba(0,150,255,0.4);
    border-radius: 50%;
    border: 2px solid white;
    font-size: 22px;
    color: white;
    user-select: none;
    z-index: 1000;
  }
  #touchShootBtn:active {
    background: rgba(0,150,255,0.8);
  }
</style>
</head>
<body>

<div id="nameInputContainer">
  <label for="playerNameInput">请输入您的名字：</label>
  <input type="text" id="playerNameInput" maxlength="12" placeholder="你的名字" />
  <button id="startGameBtn">开始游戏</button>
</div>

<canvas id="gameCanvas" width="500" height="700" style="display:none;"></canvas>
<div id="result"></div>

<!-- 触屏控制元素 -->
<div id="touchJoystick" style="display:none;"></div>
<button id="touchShootBtn" style="display:none;">射击</button>

<!-- Firebase SDK 和 游戏逻辑 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC-iUFFdMZqfqOkIdExdq8G9ORyzfutay4",
    authDomain: "ranking-b8b7.firebaseapp.com",
    databaseURL: "https://ranking-b8b7-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "ranking-b8b7",
    storageBucket: "ranking-b8b7.appspot.com",
    messagingSenderId: "1094844971919",
    appId: "1:1094844971919:web:b526bd952f871bc8f6a9fa",
    measurementId: "G-NG7CDK13VN"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const explosionSound = new Audio("https://actions.google.com/sounds/v1/explosions/explosion.ogg");
  const shootSound = new Audio("https://actions.google.com/sounds/v1/weapons/laser_gun.ogg");

  let keys = {};
  let bullets = [];
  let enemies = [];
  let score = 0;
  let lives = 5;
  let gameOver = false;
  let infiniteMode = false; // 仅电脑端w键模式可用
  let playerName = "";

  let shootCooldown = 0;
  const normalShootCooldownMax = 15;

  let lostChancesUsed = 0;

  let enemySpawnInterval = 1200;
  let enemySpawnTimerId = null;
  let enemySpeedMultiplier = 1;
  let enemyHPBase = 1;
  let spacebarBulletDamage = 1;

  const spaceship = {
    x: canvas.width / 2 - 25,
    y: canvas.height - 80,
    width: 50,
    height: 60,
    speed: 7,
  };

  class Bullet {
    constructor(x, y, damage) {
      this.x = x;
      this.y = y;
      this.width = 6;
      this.height = 14;
      this.damage = damage;
    }
    draw() {
      ctx.fillStyle = "cyan";
      ctx.fillRect(this.x, this.y, this.width, this.height);
    }
    update() {
      this.y -= 15;
    }
  }

  class Enemy {
    constructor(x, y, speed, hp) {
      this.x = x;
      this.y = y;
      this.width = 40;
      this.height = 40;
      this.speed = speed;
      this.hp = hp;
      this.alpha = 1;
      this.fading = false;
    }
    draw() {
      ctx.globalAlpha = this.alpha;
      ctx.fillStyle = "red";
      ctx.fillRect(this.x, this.y, this.width, this.height);

      if (!this.fading) {
        ctx.fillStyle = "lime";
        let hpBarWidth = (this.hp / enemyHPBase) * this.width;
        ctx.fillRect(this.x, this.y - 8, hpBarWidth, 5);
      }

      ctx.globalAlpha = 1;
    }
    update() {
      this.y += this.speed * enemySpeedMultiplier;

      if (this.fading) {
        this.alpha -= 0.01;
        if (this.alpha <= 0) {
          enemies.splice(enemies.indexOf(this), 1);
          lostChancesUsed++;
          if (lostChancesUsed >= 5) {
            endGame();
          }
        }
      }
    }
  }

  function spawnEnemy() {
    if (gameOver) return;

    let x = Math.random() * (canvas.width - 40);
    let speed = 0.5 + Math.random() * 0.75;
    let hp = enemyHPBase;
    enemies.push(new Enemy(x, -40, speed, hp));
  }

  function startEnemySpawner() {
    if (enemySpawnTimerId) clearInterval(enemySpawnTimerId);
    enemySpawnTimerId = setInterval(spawnEnemy, enemySpawnInterval);
  }

  function shoot(isOverpower = false) {
    if (gameOver) return;
    if (shootCooldown > 0 && !isOverpower) return;

    shootCooldown = normalShootCooldownMax;

    if (isOverpower) {
      for (let offset = -20; offset <= 20; offset += 10) {
        bullets.push(new Bullet(spaceship.x + spaceship.width / 2 + offset - 3, spaceship.y - 10, 1));
      }
      shootSound.currentTime = 0;
      shootSound.play();
    } else {
      bullets.push(new Bullet(spaceship.x + spaceship.width / 2 - 3, spaceship.y - 10, spacebarBulletDamage));
      shootSound.currentTime = 0;
      shootSound.play();
    }
  }

  function endGame() {
    gameOver = true;
    clearInterval(enemySpawnTimerId);
    enemies = [];
    bullets = [];
    draw();

    saveScoreToFirebase(playerName, score);

    const resultDiv = document.getElementById("result");
    resultDiv.style.display = "block";
    resultDiv.innerHTML = `
      <p>游戏结束</p>
      <p>玩家：${playerName}</p>
      <p>得分：${score}</p>
      <button onclick="location.href='minigames.html'">再玩一次</button>
      <button onclick="location.href='ranking.html'">查看排行榜</button>
    `;

    canvas.style.display = "none";
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "white";
    ctx.fillRect(spaceship.x, spaceship.y, spaceship.width, spaceship.height);

    bullets.forEach(b => b.draw());
    enemies.forEach(e => e.draw());

    ctx.fillStyle = "white";
    ctx.font = "20px Arial";
    ctx.fillText("分数: " + score, 10, 30);
    ctx.fillText("生命: " + lives, 10, 60);

    if (gameOver) {
      ctx.fillStyle = "white";
      ctx.font = "40px Arial";
      ctx.textAlign = "center";
      ctx.fillText("游戏结束", canvas.width / 2, canvas.height / 2);
      ctx.textAlign = "left";
    }
  }

  function update() {
    if (gameOver) return;

    // 飞船移动
    if (keys["ArrowLeft"]) spaceship.x -= spaceship.speed;
    if (keys["ArrowRight"]) spaceship.x += spaceship.speed;
    if (keys["a"]) spaceship.x -= spaceship.speed;
    if (keys["d"]) spaceship.x += spaceship.speed;

    // 电脑端无敌模式（w键开启）
    if (!isTouchDevice() && keys["w"]) {
      lives = 9999;
      infiniteMode = true;
    } else if (!isTouchDevice() && infiniteMode) {
      // 松开w键后恢复正常生命
      lives = Math.max(lives, 5);
      infiniteMode = false;
    }

    if (spaceship.x < 0) spaceship.x = 0;
    if (spaceship.x + spaceship.width > canvas.width) spaceship.x = canvas.width - spaceship.width;

    if (shootCooldown > 0) shootCooldown--;

    // 子弹移动
    bullets.forEach((b, index) => {
      b.update();
      if (b.y + b.height < 0) bullets.splice(index, 1);
    });

    // 敌人移动及碰撞检测
    enemies.forEach((e, eIndex) => {
      e.update();

      if (!e.fading) {
        bullets.forEach((b, bIndex) => {
          if (
            b.x < e.x + e.width &&
            b.x + b.width > e.x &&
            b.y < e.y + e.height &&
            b.y + b.height > e.y
          ) {
            e.hp -= b.damage;
            bullets.splice(bIndex, 1);
            if (e.hp <= 0) {
              e.fading = true;
              score++;
              explosionSound.currentTime = 0;
              explosionSound.play();

              if (score % 10 === 0) {
                enemySpeedMultiplier += 0.15;
                enemyHPBase += 0.5;
                spacebarBulletDamage += 0.1;
                enemySpawnInterval = Math.max(200, enemySpawnInterval - 100);
                startEnemySpawner();
              }
            }
          }
        });
      }

      if (e.y > canvas.height && !e.fading) {
        e.fading = true;
        lostChancesUsed++;
        if (lostChancesUsed >= 5) {
          endGame();
        }
      }
    });

    draw();
    requestAnimationFrame(update);
  }

  function saveScoreToFirebase(name, score) {
    if (!name) return;
    const scoreRef = ref(db, "scores");
    push(scoreRef, {
      name: name,
      score: score,
      timestamp: Date.now(),
    });
  }

  // 输入框、开始游戏逻辑
  const nameInput = document.getElementById("playerNameInput");
  const startBtn = document.getElementById("startGameBtn");
  const nameContainer = document.getElementById("nameInputContainer");

  startBtn.addEventListener("click", () => {
    let val = nameInput.value.trim();
    if (val === "") {
      alert("请输入名字！");
      return;
    }
    playerName = val;
    startGame();
  });

  function startGame() {
    nameContainer.style.display = "none";
    canvas.style.display = "block";
    score = 0;
    lives = 5;
    gameOver = false;
    lostChancesUsed = 0;
    enemySpeedMultiplier = 1;
    enemyHPBase = 1;
    spacebarBulletDamage = 1;
    enemySpawnInterval = 1200;
    bullets = [];
    enemies = [];
    shootCooldown = 0;
    startEnemySpawner();
    update();
  }

  // 键盘事件监听
  window.addEventListener("keydown", (e) => {
    keys[e.key.toLowerCase()] = true;

    // 普通射击：空格
    if (e.key === " ") {
      shoot(false);
    }
  });

  window.addEventListener("keyup", (e) => {
    keys[e.key.toLowerCase()] = false;
  });

  // 触屏摇杆和射击按钮逻辑
  const touchJoystick = document.getElementById("touchJoystick");
  const touchShootBtn = document.getElementById("touchShootBtn");

  function isTouchDevice() {
    return (
      "ontouchstart" in window ||
      navigator.maxTouchPoints > 0 ||
      navigator.msMaxTouchPoints > 0
    );
  }

  if (isTouchDevice()) {
    touchJoystick.style.display = "block";
    touchShootBtn.style.display = "block";
  }

  let dragging = false;
  let joystickCenterX = 0;

  touchJoystick.addEventListener("touchstart", (e) => {
    e.preventDefault();
    dragging = true;
    joystickCenterX = e.touches[0].clientX;
    touchJoystick.classList.add("active");
  });

  touchJoystick.addEventListener("touchmove", (e) => {
    e.preventDefault();
    if (!dragging) return;
    let offset = e.touches[0].clientX - joystickCenterX;
    if (offset > 40) offset = 40;
    if (offset < -40) offset = -40;
    spaceship.x += offset * 0.15;
    if (spaceship.x < 0) spaceship.x = 0;
    if (spaceship.x + spaceship.width > canvas.width) spaceship.x = canvas.width - spaceship.width;
  });

  touchJoystick.addEventListener("touchend", (e) => {
    e.preventDefault();
    dragging = false;
    touchJoystick.classList.remove("active");
  });

  touchShootBtn.addEventListener("touchstart", (e) => {
    e.preventDefault();
    shoot(false);
  });
</script>

</body>
</html>
